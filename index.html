<!DOCTYPE html>
<html>
<head>
    <title>My Mapbox Map</title>
    <!-- Add Mapbox CSS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map {
            width: 100vw;
            height: 100vh;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Add Mapbox JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2NobWlkc3RhIiwiYSI6ImNscG02OWFvdTA1aTUya3FuZ2tzbnB6ejAifQ.bxFVJbOBulC_Y9YskaKxjg';

        var map;
        var locationMarker;

        // Function to initialize the map
        function initializeMap(longitude, latitude) {
            map = new mapboxgl.Map({
                container: 'map', // container ID
                style: 'mapbox://styles/schmidsta/cl8zj69gv000014piwjpgxkcv', // style URL
                center: [longitude, latitude], // starting position [lng, lat]
                zoom: 17 // starting zoom
            });

            // Create a new marker for the user's location
            locationMarker = new mapboxgl.Marker()
                .setLngLat([longitude, latitude])
                .addTo(map);
        }

        // Function to update the marker's position
        function updateMarkerPosition(longitude, latitude) {
            locationMarker.setLngLat([longitude, latitude]);
        }

        // Function to adjust map's bearing based on device orientation
        function setupOrientationListener() {
            window.addEventListener('deviceorientation', function(event) {
                var alpha = event.alpha;
                if (alpha !== null) {
                    map.setBearing(alpha);
                }
            });
        }

        // Request permission for device orientation on iOS 13+ devices
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        setupOrientationListener();
                    }
                })
                .catch(console.error);
        } else {
            // Setup for non iOS 13+ devices
            setupOrientationListener();
        }

        // Get and watch user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                initializeMap(position.coords.longitude, position.coords.latitude);
                
                // Watch the position and update marker accordingly
                navigator.geolocation.watchPosition(function(position) {
                    updateMarkerPosition(position.coords.longitude, position.coords.latitude);
                }, function(error) {
                    console.log("Error: " + error.message);
                }, {
                    enableHighAccuracy: true
                });

            }, function() {
                initializeMap(149.131, -35.270); // Default location
            });
        } else {
            initializeMap(149.131, -35.270); // Default location
        }
    </script>
</body>
</html>
